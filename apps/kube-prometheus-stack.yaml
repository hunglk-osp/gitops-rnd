apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "-3"
spec:
  project: default
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: "*"
    helm:
      values: |
        prometheus:
          prometheusSpec:
            serviceMonitorSelectorNilUsesHelmValues: false
            serviceMonitorSelector: {}
            serviceMonitorNamespaceSelector: {}
            podMonitorSelectorNilUsesHelmValues: false
            podMonitorSelector: {}
            podMonitorNamespaceSelector: {}
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: local-path
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 10Gi
          ingress:
            enabled: true
            ingressClassName: traefik
            hosts:
              - prometheus.rnd
        alertmanager:
          config:
            global:
              resolve_timeout: 5m
            route:
              group_by: ['alertname', 'severity']
              group_wait: 30s
              group_interval: 5m
              repeat_interval: 1h
              receiver: 'null'
              routes:
                - matchers:
                    - alertname = Watchdog
                  receiver: 'null'
                - matchers:
                    - alertname =~ "KubeProxy.*|KubeScheduler.*|KubeControllerManager.*|KubeAggregated.*"
                  receiver: 'null'
                - matchers:
                    - severity =~ "warning|critical"
                  receiver: 'webhook'
            inhibit_rules:
              - source_matchers:
                  - severity = critical
                target_matchers:
                  - severity = warning
                equal: ['alertname']
            receivers:
              - name: 'null'
              - name: 'webhook'
                webhook_configs:
                  - url: 'http://lark-alertmanager-webhook.monitoring.svc.cluster.local:8080/webhook'
                    send_resolved: true
          alertmanagerSpec:
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: local-path
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 2Gi
        additionalPrometheusRulesMap:
          node-memory-alerts:
            groups:
              - name: node-memory
                rules:
                  - alert: HighNodeMemoryUsage
                    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 70
                    for: 5m
                    labels:
                      severity: warning
                    annotations:
                      summary: "High memory usage on {{ $labels.instance }}"
                      description: "Memory usage is {{ $value | humanize }}% on node {{ $labels.instance }}"
                  - alert: CriticalNodeMemoryUsage
                    expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
                    for: 2m
                    labels:
                      severity: critical
                    annotations:
                      summary: "Critical memory usage on {{ $labels.instance }}"
                      description: "Memory usage is {{ $value | humanize }}% on node {{ $labels.instance }}"
        kubeProxy:
          enabled: false
        kubeScheduler:
          enabled: false
        kubeControllerManager:
          enabled: false
        grafana:
          enabled: true
          adminPassword: "admin123"
          persistence:
            enabled: true
            storageClassName: local-path
            size: 5Gi
          ingress:
            enabled: true
            ingressClassName: traefik
            hosts:
              - grafana.rnd
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  ignoreDifferences:
    - group: apps
      kind: StatefulSet
      jsonPointers:
        - /spec/volumeClaimTemplates/0/apiVersion
        - /spec/volumeClaimTemplates/0/kind
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - RespectIgnoreDifferences=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
